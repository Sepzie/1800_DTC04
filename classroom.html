<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My BCIT Project</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Bootstrap FirebaseUI CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />


    <!-- Google Icons (Material Design)-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>

    <script src="scripts/firebaseAPI.js"></script>

    <!-- Link to the api keys for your firebase project -->
    <link href="./styles/my_style.css" rel="stylesheet">

    <!-- CDN-->
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />
    <!--Final CSS-->
    <link href="./styles/colour_styles.css" rel="stylesheet">

    <style>
        section {
            margin-top: 5%;
        }

        a {
            margin-bottom: 2%;
        }

        #topnav {
            font-size: larger;
        }

        #navbar {
            margin: auto;
        }
    </style>


</head>

<body id="body">
    <nav class="navbar navbar-expand-lg navbar-light bg-primary" id="navbar">
        <div class="container-fluid">
            <span class="navbar-brand" href="main">VLB</span>
            <a href="/profile.html"><img class="bi-window text-primary" id="profile" src="./images/account.png"
                    alt="..."></a>

        </div>
    </nav>

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="./main.html">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Classroom</li>
        </ol>
    </nav>


    <ul class="nav nav-pills nav-fill" id="topnav">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Classroom</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="notes.html">Notes</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#">Clips</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="todo.html">To-Do</a>
        </li>
    </ul>


    <template id="DateTemplate" class="container">
        <div class="row">
            <p class="date-goes-here col list-group-item list-group-item-action active">
                25 November, 2021
            </p>
        </div>
        <div class="row class-goes-here">

        </div>
    </template>

    <template id="ClassTemplate" class="row">
        <div class="col-sm">
            <div class="card" style="width: 18rem;">
                <div class="card-body">
                    <h5 class="card-title">COMP 1537</h5>
                    <p class="card-text class-name">Web Development</p>
                    <p class="card-text instructor">Instructor: Arron Ferguson</p>
                    <p class="card-text time">Time: 8:30-10:20</p>
                    <a href="#" class="btn btn-primary">Join</a>
                </div>
            </div>
        </div>
    </template>


    <script>
        function insertName() {
            firebase.auth().onAuthStateChanged(user => {
                // Check if user is signed in:
                if (user) {
                    // Do something for the current logged-in user here: 
                    console.log(user.uid);
                    //go to the correct user document by referencing to the user uid
                    currentUser = db.collection("users").doc(user.uid)

                    //get the document for current user.
                    currentUser.get()
                        .then(userDoc => {
                            var user_Name = userDoc.data().name;
                            userSet = userDoc.data().set
                            displaySchedule(userSet)
                            //console.log(user_Name);
                            //document.getElementById("username").innerText = n;                     //using javascript
                            $("#name-goes-here1").text(user_Name); //using jquery
                        })
                } else {
                    // No user is signed in.
                    console.log("no user signed in")
                }
            });
        }

        function displaySchedule(userSet) {
            let DateTemplate = document.getElementById("DateTemplate")
            let ClassTemplate = document.getElementById("ClassTemplate")

            var set = db.collection("classes").doc(userSet)
            set.get()
                .then(setDoc => {
                    var Dates = setDoc.data().Dates;
                    for (i = 0; i < Dates.length; i++) {
                        // This for loop iterates through the dates inside a set and creates a banner for each
                        let date = Dates[i];
                        let newdate = DateTemplate.content.cloneNode(true)
                        newdate.querySelector('.date-goes-here').innerHTML = date
                        newdate.querySelector('.class-goes-here').setAttribute("id", date)
                        document.getElementById('body').appendChild(newdate)
                        // It then creates the cards for each class under it's banner
                        set.collection(date).get().then(snap => {
                            snap.forEach(classDoc => { //iterate thru each doc (class)
                                var CourseID = classDoc.data().CourseID
                                var Instructor = classDoc.data().Instructor
                                var Time = classDoc.data().Time
                                var ClassName = classDoc.data().CourseName

                                let newclass = ClassTemplate.content.cloneNode(true)
                                // update class card
                                newclass.querySelector('.card-title').innerHTML = CourseID
                                newclass.querySelector('.class-name').innerHTML = ClassName
                                newclass.querySelector('.instructor').innerHTML = "Instructor: " +
                                    Instructor
                                newclass.querySelector('.time').innerHTML = "Time: " + Time
                                newclass.querySelector('.card-body').setAttribute("id", date +
                                    CourseID)
                                document.getElementById(date).appendChild(newclass);


                            })
                        })
                    }
                })
        }

        async function getClassCSVdata() {
            const response = await fetch('./class_data.csv'); //send get request
            const data = await response.text(); //get file response
            const list = data.split('\n').slice(1); //get line
            list.forEach(async row => {
                const columns = row.split(','); //get token 
                const set = columns[0];
                const date = columns[1];
                const courseID = columns[2];
                const courseName = columns[3];
                const instructor = columns[4];
                const time = columns[5];
                
                // Update the array of class dates with the dates of all classes
                const classDates = db.collection('classes').doc(set);
                const addDates = await classDates.update({
                    Dates: firebase.firestore.FieldValue.arrayUnion(date)
                })

                classData = {
                    CourseID: courseID,
                    CourseName: courseName,
                    Instructor: instructor,
                    Time: time
                }

                // console.log(classData)
                db.collection('classes').doc(set).collection(date).add(classData)

                //  db.collection("classes").doc(set).add({ //write to firestore
                //     name: country,
                //     details: details
                // })

            })
        }


        insertName();
    </script>


</body>

</html>