<!DOCTYPE html>

<head lang="en" style="margin: auto; padding: 0px;">
    <title>View Notes</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./styles/my_style.css">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap FirebaseUI CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />

    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <meta name="viewport" content="width=device-width, initial-scale=1">


    <!-- Link to the api keys for your firebase project -->
    <script src="scripts/firebaseAPI.js"></script>

    <!-- CDN-->
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-primary" id="navbar">
        <div class="container-fluid">
            <span class="navbar-brand" href="main">VLB</span>
            <a href="/profile.html"><img class="bi-window text-primary" id="profile" src="./images/account.png"
                    alt="..."></a>

        </div>
    </nav>
    <div class="row">
        <a href="#" class="col list-group-item list-group-item-action active">
            24 November, 2021
        </a>
    </div>

    <template id="CardTemplate" style="margin: auto;">
        <div class="card py-2 mx-2" style="width: 18rem; margin: 5%">
            <div class="card-body">
                <h5 class="card-title">...</h5>
                <p class="card-text">...</p>
                <a class="btn btn-secondary edit" onclick="setEditNoteData(this.id)" href="./updatenotes.html">Edit</a>
                <a class="btn btn-info delete" id="SaveButton" onclick="deleteNote(this.id), deleteRefresh(this)">Delete</a>
            </div>
        </div>
    </template>

    <div class="container" style="width: 100%; padding: 0px;">
        <h1 style="display: inline-block; margin-top: 5%; margin-left: 5%; font-size: 1.5em;" id="notes"></h1>
        <a href="./notetakingpage.html" class="btn btn-primary btn-lg active" role="button" aria-pressed="true"
            style="float: right; margin: 5% 5%; border-radius: 50%;">+</a>
        <div class="container">
            <div id="courseNotes-go-here" class="row row-cols-auto">

            </div>
        </div>
    </div>
    <script>
        var currentUser;

        function deleteNote(id) {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    let note_collection = localStorage.getItem("course")
                    let doc_id = id.slice(1,)
                    db.collection("users").doc(user.uid).collection(note_collection).doc(doc_id).delete();
                    console.log("Deleted!")
                } else {
                }
            });
        }

        function deleteRefresh(node_id) {
            node_id.parentNode.removeChild(node_id.parentNode.parentNode.parentNode.parentNode)
        }

        function courseNotes() {
            let course = localStorage.getItem('course');
            console.log(course);
            
            displayNotes(course);

            document.getElementById('notes').innerHTML = course + ' Notes';
        };

        courseNotes();

        function displayNotes(collection) {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    let CardTemplate = document.getElementById("CardTemplate");

                    db.collection("users").doc(user.uid).collection(collection).get()
                        .then(snap => {
                            var i = 1;
                            snap.forEach(doc => {
                                var title = doc.data().Title;
                                var details = doc.data().Note.slice(0, 30);
                                let newcard = CardTemplate.content.cloneNode(true);
                                console.log(doc.id)
                                newcard.querySelector('.card-title').innerHTML = title;

                                if (details.length >= 20) {
                                    details = details.slice(0,20) + "...";
                                }
                                newcard.querySelector('.card-text').innerHTML = details;

                                newcard.querySelector('.card-title').setAttribute("id", "ctitle" +
                                    i);
                                newcard.querySelector('.card-text').setAttribute("id", "ctext" + i);

                                newcard.querySelector('.edit').setAttribute("id", "e" + doc.id);
                                newcard.querySelector('.delete').setAttribute("id", "d" + doc.id);
                                document.getElementById("courseNotes-go-here").appendChild(
                                    newcard);
                                i++;
                            })
                        })
                } else {

                }
            });
        }

        function setEditNoteData (id){
            let Note_ID = id.slice(1,)
            localStorage.setItem("noteId", Note_ID)
        }

        function insertName() {
            firebase.auth().onAuthStateChanged(user => {
                // Check if user is signed in:
                if (user) {
                    // Do something for the current logged-in user here: 
                    console.log(user.uid);
                    //go to the correct user document by referencing to the user uid
                    currentUser = db.collection("users").doc(user.uid);
                    //get the document for current user.
                    currentUser.get().then(userDoc => {
                        var user_Name = userDoc.data().name;
                        console.log(user_Name);
                        //method #1:  insert with html only
                        //document.getElementById("name-goes-here").innerText = n;    //using javascript
                        //method #2:  insert using jquery
                        $("#name-goes-here").text(user_Name); //using jquery
                    })
                } else {
                    // No user is signed in.
                }
            });
        }
        insertName();
    </script>
</body>