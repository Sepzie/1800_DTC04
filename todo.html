<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My BCIT Project</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Bootstrap FirebaseUI CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />


    <!-- Google Icons (Material Design)-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>

    <script src="scripts/firebaseAPI.js"></script>

    <!-- Link to the api keys for your firebase project -->
    <link href="./styles/colour_styles.css" rel="stylesheet">

    <!-- CDN-->
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />

    <!--Final CSS-->
    <link href="./styles/colour_styles.css" rel="stylesheet">

    <style>
        section {
            margin-top: 5%;
        }

        a {
            margin-bottom: 2%;
        }

        #topnav {
            font-size: larger;
        }

        #navbar {
            margin: auto;
        }

        #profile {
            margin-right: 40%;
        }
    </style>

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-primary" id="navbar">
        <div class="container-fluid">
            <span class="navbar-brand" href="main">VLB</span>
            <a href="/profile.html"><img class="bi-window text-primary" id="profile" src="./images/account.png"
                    alt="..."></a>

        </div>
    </nav>



    <ul class="nav nav-pills nav-fill" id="topnav">
        <li class="nav-item">
            <a class="nav-link" href="classroom.html">Classroom</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="notes.html">Notes</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#">Clips</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="#" aria-current="page">To-Do</a>
        </li>
    </ul>

    <template id="CardTemplate" style="margin: auto;">
        <div class="card py-2 mx-2 dataCards" style="width: 18rem; margin: 5%">
            <div class="card-body">
                <h5 class="card-item">...</h5>
                <p class="card-date">...</p>
                <p class="doc-id" style="display: none;">...</p>
                <a class="btn btn-info EditButton" href="todomore.html" style="float: left; font-size: 0.6em;"
                    onclick="setEditData(this.id)">Edit</a>
                <a class="btn btn-danger DeleteButton" style="float: right; font-size: 0.6em;"
                    onclick="deleteTodo(this.id), displayAfterDelete(this)">Delete</a>
            </div>
        </div>
    </template>

    <div class="pb-2">
        <div class="card">
            <div id="main-area" class="card-body">
                <div class="d-flex flex-row align-items-center" style="margin-bottom: 5%;">
                    <input type="text" class="form-control form-control-lg" id="exampleFormControlInput1"
                        placeholder="Add new...">
                    <a href="#!" data-mdb-toggle="tooltip" title="Set due date"><i
                            class="fas fa-calendar-alt fa-lg me-3"></i></a>
                    <div>
                        <button type="button" class="btn btn-primary" onclick="saveUserTodo()">Add</button>
                    </div>
                </div>
                <div class="container h-100">
                    <div class="row">
                        <label for="exampleFormControlTextarea1" class="col align-self-center"><b>Due Date:</b></label>
                        <input type="date" class="form-control col" id="myDate" value="2021-12-01">
                    </div>
                </div>
                
                <div>  
                    <label>Sort By Date: </label>
                    <button class="btn btn-primary" onclick="sortByAscending()"> Ascending </button>
                    <button class="btn btn-primary" onclick="sortByDescending()"> Descending </button>
                </div>
            </div>
            

        </div>
    </div>
    
    
    
    <div class="container">
        
        
        
        <div id="todoitem-go-here" class="row row-cols-auto">

        </div>
    </div>


    <script>
        var currentUser

        function saveUserTodo() {
            firebase.auth().onAuthStateChanged(user => {
                // Check if user is signed in:
                if (user) {
                    // Do something for the current logged-in user here:
                    console.log(user.uid);
                    //go to the correct user document by referencing to the user uid
                    //Save new info to database
                    todo = document.getElementById('exampleFormControlInput1').value; //get the value of the field with id="exampleFormControlInput1"
                    date = document.getElementById('myDate').value;

                    console.log(todo);
                    console.log(date)

                    currentUser = db.collection("users").doc(user.uid).collection("todo");

                    currentUser.add({
                        To_Do: todo,
                        Due_Date: date
                    })

                        .then(function (docRef) {
                            console.log("Document written with ID: ", docRef.id);
                            doc_id = docRef.id
                            currentUser.doc(docRef.id).set({
                                To_Do: todo,
                                Due_Date: date,
                                Doc_ID: docRef.id
                            })
                            displayNewTodo(todo, date, doc_id);
                        })
                    console.log(todo + ' and ' + date + ' was added to the To-Do List')
                } else {
                    // No user is signed in.
                }
            });
        }

        function displayNewTodo(string, date, id) {
            let newcard = CardTemplate.content.cloneNode(true);
            //update title and text and image
            newcard.querySelector('.card-item').innerHTML = string;
            newcard.querySelector('.card-date').innerHTML = "Due Date: " + date;
            newcard.querySelector('.doc-id').innerHTML = id;


            //attach to gallery
            document.getElementById("todoitem-go-here").appendChild(newcard);

        }

        function displayAfterDelete(id) {
            id.parentNode.parentNode.parentNode.removeChild(id.parentNode.parentNode)
        }


        function deleteTodo(id) {
            firebase.auth().onAuthStateChanged(user => {
                // Check if user is signed in:
                if (user) {
                    console.log(id)
                    // Do something for the current logged-in user here:

                    //go to the correct user document by referencing to the user uid
                    //Save new info to database

                    // let doc_id = document.getElementsByName().id

                    db.collection("users").doc(user.uid).collection("todo").doc(id).delete();
                    console.log('Successfully deleted ' + id)




                } else {
                    // No user is signed in.
                }
            });
        }

        function setEditData(id) {
            var doc_id = id.slice(1,)
            localStorage.setItem("Doc_ID", doc_id)

        }

        function displayTodo() {
            firebase.auth().onAuthStateChanged(user => {
                // Check if user is signed in:
                if (user) {
                    let CardTemplate = document.getElementById("CardTemplate");

                    db.collection("users").doc(user.uid).collection("todo").get()
                        .then(snap => {
                            var i = 1;
                            snap.forEach(doc => { //iterate thru each doc
                                var item = doc.data().To_Do;
                                var date = doc.data().Due_Date;
                                var doc_id = doc.data().Doc_ID
                                let newcard = CardTemplate.content.cloneNode(true);

                                //update title and text and image
                                newcard.querySelector('.card-item').innerHTML = item;
                                newcard.querySelector('.card-date').innerHTML = "Due Date: " + date;
                                newcard.querySelector('.doc-id').innerHTML = doc_id;

                                //give unique ids to all elements for future use
                                newcard.querySelector('.card-item').setAttribute("id", "citem" + i);
                                newcard.querySelector('.card-date').setAttribute("id", "cdate" + i);
                                newcard.querySelector('.doc-id').setAttribute("name", "doc-id" + i);
                                newcard.querySelector('.doc-id').setAttribute("id", doc_id)
                                newcard.querySelector('.DeleteButton').setAttribute("id", doc_id)
                                newcard.querySelector('.EditButton').setAttribute("id", "u" + doc_id)

                                //attach to gallery
                                document.getElementById("todoitem-go-here").appendChild(newcard);
                                i++;
                            })
                        })
                } else {

                }
            });
        }

        function sortByAscending() {
            firebase.auth().onAuthStateChanged(user => {
                // Check if user is signed in:
                if (user) {
                    const card = document.querySelector('.dataCards');
                    card.parentElement.innerHTML = "";

                    let CardTemplate = document.getElementById("CardTemplate");

                    db.collection("users").doc(user.uid).collection("todo").orderBy("Due_Date").get()
                        .then(snap => {
                            var i = 1;
                            snap.forEach(doc => { //iterate thru each doc
                                var item = doc.data().To_Do;
                                var date = doc.data().Due_Date;
                                var doc_id = doc.data().Doc_ID
                                let newcard = CardTemplate.content.cloneNode(true);

                                //update title and text and image
                                newcard.querySelector('.card-item').innerHTML = item;
                                newcard.querySelector('.card-date').innerHTML = "Due Date: " + date;
                                newcard.querySelector('.doc-id').innerHTML = doc_id;

                                //give unique ids to all elements for future use
                                newcard.querySelector('.card-item').setAttribute("id", "citem" + i);
                                newcard.querySelector('.card-date').setAttribute("id", "cdate" + i);
                                newcard.querySelector('.doc-id').setAttribute("name", "doc-id" + i);
                                newcard.querySelector('.doc-id').setAttribute("id", doc_id)
                                newcard.querySelector('.DeleteButton').setAttribute("id", doc_id)
                                newcard.querySelector('.EditButton').setAttribute("id", "u" + doc_id)


                                // window.location.href = "/todo.html";


                                //attach to gallery
                                document.getElementById("todoitem-go-here").appendChild(newcard);
                                i++;
                            })
                        })

                } else {

                }
            });
        }

        function sortByDescending() {
            firebase.auth().onAuthStateChanged(user => {
                // Check if user is signed in:
                if (user) {
                    const card = document.querySelector('.dataCards');
                    card.parentElement.innerHTML = "";

                    let CardTemplate = document.getElementById("CardTemplate");

                    db.collection("users").doc(user.uid).collection("todo").orderBy("Due_Date", "desc").get()
                        .then(snap => {
                            var i = 1;
                            snap.forEach(doc => { //iterate thru each doc
                                var item = doc.data().To_Do;
                                var date = doc.data().Due_Date;
                                var doc_id = doc.data().Doc_ID
                                let newcard = CardTemplate.content.cloneNode(true);

                                //update title and text and image
                                newcard.querySelector('.card-item').innerHTML = item;
                                newcard.querySelector('.card-date').innerHTML = "Due Date: " + date;
                                newcard.querySelector('.doc-id').innerHTML = doc_id;

                                //give unique ids to all elements for future use
                                newcard.querySelector('.card-item').setAttribute("id", "citem" + i);
                                newcard.querySelector('.card-date').setAttribute("id", "cdate" + i);
                                newcard.querySelector('.doc-id').setAttribute("name", "doc-id" + i);
                                newcard.querySelector('.doc-id').setAttribute("id", doc_id)
                                newcard.querySelector('.DeleteButton').setAttribute("id", doc_id)
                                newcard.querySelector('.EditButton').setAttribute("id", "u" + doc_id)


                                // window.location.href = "/todo.html";


                                //attach to gallery
                                document.getElementById("todoitem-go-here").appendChild(newcard);
                                i++;
                            })
                        })

                } else {

                }
            });
        }

        
        displayTodo();
    </script>


</body>

</html>